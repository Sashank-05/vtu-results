<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrape Student Data</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="static/main.css" rel="stylesheet">
</head>
<style>
    .hoverable {
        width: 40px;
        height: 40px;
        text-align: center;
        border: 1px solid #ccc;
        color: #BE3144;
        background: #09122C;
    }

    .fetched {
        background-color: #4CAF50; /* Green when fetched */
    }
</style>
<body>
<div class="glow"></div>
<div class="container">
    <header>
        <h1>Scrape Student Data</h1>
        <p class="subtext">Fetch results quickly and efficiently</p>
    </header>

    <div class="analysis-container">
        <div class="input-card">
            <div class="input-field">
                <i class="material-icons">person</i>
                <input type="text" id="usnPrefix" placeholder=" " required>
                <label for="usnPrefix">Enter USN Prefix (e.g., 1BI23CD)</label>
            </div>

            <div class="input-field">
                <i class="material-icons">link</i>
                <input type="text" id="customUrl" placeholder=" ">
                <label for="customUrl">Enter the custom URL for scraping</label>
            </div>

            <div class="input-field">
                <i class="material-icons">filter_1</i>
                <input type="text" id="sem" placeholder=" " required>
                <label for="sem">Enter Semester (e.g., 1)</label>
            </div>

            <div class="input-field">
                <i class="material-icons">confirmation_number</i>
                <input type="text" id="endUsn" placeholder=" " required>
                <label for="endUsn">Enter Last USN Number (e.g., 56)</label>
            </div>

            <div class="input-field">
                <i class="material-icons">settings</i>
                <input type="text" id="numThreads" placeholder=" " value="4">
                <label for="numThreads">Number of Threads (Default: 4)</label>
            </div>

            <div class="action-buttons">
                <button class="glass-button" onclick="startScraping()">
                    <span>Start Scraping</span>
                    <i class="material-icons">play_arrow</i>
                </button>
            </div>
        </div>
    </div>

    <div id="results" class="results"></div>

    <div class="live-progress">
        <h2>Live Scraping Progress</h2>
        <div class="table-container">
            <table id="usn-table" class="responsive-table">
                <thead id="table-header"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const socket = io.connect('http://' + document.domain + ':' + location.port);

    function startScraping() {
        const usnPrefix = document.getElementById("usnPrefix").value;
        const customUrl = document.getElementById("customUrl").value;
        const sem = document.getElementById("sem").value;
        const endUsn = document.getElementById("endUsn").value;
        const numThreads = document.getElementById("numThreads").value;

        const payload = {
            usn_prefix: usnPrefix,
            custom_url: customUrl,
            sem: sem,
            end_usn: endUsn,
            num_threads: numThreads || 4
        };

        fetch("/api/v1/scrape", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        })
                .then(response => response.json())
                .then(data => {
                    const resultsDiv = document.getElementById("results");
                    if (data.success) {
                        resultsDiv.innerHTML = "";
                        document.querySelector('.live-progress').style.display = 'block';
                        generateTable(endUsn);
                    } else {
                        resultsDiv.innerHTML = `<p class="error">Error: ${data.error}</p>`;
                    }
                })
                .catch(error => {
                    document.getElementById("results").innerHTML =
                            `<p class="error">Error: ${error.message}</p>`;
                });
    }

    function generateTable(endUsn) {
        const body = document.getElementById("table-body");
        body.innerHTML = "";

        const usnsPerRow = 8; // Adjust to 8-10 as needed
        let row;

        for (let i = 1; i <= endUsn; i++) {
            if ((i - 1) % usnsPerRow === 0) {
                row = document.createElement("tr");
                body.appendChild(row);
            }

            const td = document.createElement("td");
            td.id = `usn-${i}`;
            td.textContent = `${i}`;
            td.classList.add('hoverable', 'pending'); // Initial class
            row.appendChild(td);
        }
    }

    function extractNumberFromUSN(usn) {
        const matches = usn.match(/\d+$/);
        return matches ? parseInt(matches[0]) : null;
    }

    socket.on('update', function (data) {
        if (data.usn) {
            const numericUSN = extractNumberFromUSN(data.usn);
            if (numericUSN) {
                const cell = document.getElementById(`usn-${numericUSN}`);
                if (cell) {
                    cell.classList.remove('pending');
                    cell.classList.add('fetched'); // Turns green
                }
            }
        }
    });
</script>
</body>
</html>